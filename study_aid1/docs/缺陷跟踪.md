# 桌面学习助手缺陷跟踪文档

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 桌面学习助手缺陷跟踪文档 |
| 版本 | 1.0.0 |
| 创建日期 | 2026-01-31 |
| 作者 | 测试团队 |

---

## 2. 缺陷管理流程

### 2.1 缺陷生命周期

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  新建   │───▶│  确认   │───▶│  修复中 │───▶│  待验证 │───▶│  关闭   │
│ (New)   │    │(Confirm)│    │ (Fixing)│    │(Verify) │    │(Closed) │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
     │              │              │              │              │
     │              │              │              │              │
     ▼              ▼              ▼              ▼              ▼
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  重复   │    │  拒绝   │    │  延期   │    │  重开   │    │  解决   │
│(Duplicate)│   │(Reject) │    │(Defer)  │    │(Reopen) │    │(Resolved)│
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
```

### 2.2 状态说明

| 状态 | 说明 | 负责人 |
|------|------|--------|
| 新建 (New) | 缺陷刚提交，待确认 | 测试工程师 |
| 确认 (Confirmed) | 缺陷已确认，待分配 | 测试负责人 |
| 修复中 (Fixing) | 开发正在修复 | 开发工程师 |
| 待验证 (Pending Verify) | 修复完成，待测试验证 | 测试工程师 |
| 关闭 (Closed) | 缺陷已解决并验证通过 | 测试工程师 |
| 重开 (Reopened) | 验证未通过，重新打开 | 测试工程师 |
| 拒绝 (Rejected) | 不是缺陷或无法复现 | 测试负责人 |
| 重复 (Duplicate) | 与已有缺陷重复 | 测试负责人 |
| 延期 (Deferred) | 推迟到后续版本修复 | 产品经理 |

---

## 3. 缺陷严重级别定义

### 3.1 严重级别分类

| 级别 | 名称 | 定义 | 响应时间 | 解决时间 |
|------|------|------|----------|----------|
| P0 | 致命 (Critical) | 系统崩溃、数据丢失、核心功能完全不可用 | 2小时 | 24小时 |
| P1 | 严重 (Major) | 主要功能异常、性能严重下降、重要功能缺失 | 4小时 | 48小时 |
| P2 | 一般 (Minor) | 次要功能异常、界面问题、非核心功能缺陷 | 1天 | 1周 |
| P3 | 轻微 (Trivial) | 文字错误、UI微调、建议性改进 | 3天 | 2周 |

### 3.2 严重级别判定标准

#### P0 - 致命缺陷
- 应用程序崩溃或无响应
- 数据丢失或损坏
- 安全漏洞（数据泄露风险）
- 核心功能完全无法使用
- 系统资源耗尽（内存泄漏等）

#### P1 - 严重缺陷
- 主要功能部分异常
- 性能下降超过50%
- 重要配置无法保存
- API连接持续失败
- 频繁的错误提示影响使用

#### P2 - 一般缺陷
- 次要功能异常但有替代方案
- 界面显示不正确但不影响功能
- 非核心配置项问题
- 日志记录不完整
- 边界条件处理不当

#### P3 - 轻微缺陷
- 文字拼写或语法错误
- 界面布局微调
- 颜色、字体不一致
- 建议性改进
- 代码优化建议

---

## 4. 缺陷报告模板

### 4.1 缺陷报告字段

```markdown
## 缺陷报告

### 基本信息
- **缺陷ID**: BUG-[日期]-[序号] (例如: BUG-20260131-001)
- **标题**: [简明描述缺陷]
- **报告人**: [姓名]
- **报告日期**: [YYYY-MM-DD]
- **所属模块**: [语音识别/截图/图像识别/AI内容/自动更新]
- **严重级别**: [P0/P1/P2/P3]
- **优先级**: [高/中/低]

### 环境信息
- **操作系统**: [Windows 10/11]
- **应用版本**: [版本号]
- **Python版本**: [3.9/3.10/3.11]
- **Node.js版本**: [18.x/20.x]
- **测试环境**: [开发/测试/生产]

### 缺陷描述
[详细描述缺陷现象]

### 复现步骤
1. [步骤1]
2. [步骤2]
3. [步骤3]
...

### 预期结果
[描述预期应该出现的结果]

### 实际结果
[描述实际出现的结果]

### 附加信息
- **截图**: [如有，请附加]
- **日志**: [相关日志片段]
- **视频**: [如有录屏，请附加]
- **频率**: [必现/偶发/随机]

### 相关用例
- **测试用例ID**: [关联的测试用例]

### 处理记录
- **确认人**: [姓名]
- **确认日期**: [YYYY-MM-DD]
- **分配给谁**: [姓名]
- **修复版本**: [版本号]
- **验证人**: [姓名]
- **验证日期**: [YYYY-MM-DD]
- **验证结果**: [通过/未通过]
- **备注**: [其他说明]
```

### 4.2 缺陷报告示例

```markdown
## 缺陷报告

### 基本信息
- **缺陷ID**: BUG-20260131-001
- **标题**: 语音识别服务在API密钥无效时未给出友好提示
- **报告人**: 张三
- **报告日期**: 2026-01-31
- **所属模块**: 语音识别服务
- **严重级别**: P1
- **优先级**: 高

### 环境信息
- **操作系统**: Windows 11
- **应用版本**: 1.0.0-beta
- **Python版本**: 3.11
- **Node.js版本**: 18.19.0
- **测试环境**: 测试环境

### 缺陷描述
当配置无效的API密钥时，语音识别服务抛出未捕获的异常，导致应用程序崩溃，而不是显示友好的错误提示信息。

### 复现步骤
1. 打开应用设置
2. 进入AI服务配置页面
3. 在语音识别服务中输入无效的API密钥
4. 保存配置
5. 尝试启动语音识别功能

### 预期结果
应用应显示友好的错误提示："API密钥无效，请检查配置"

### 实际结果
应用崩溃，控制台显示未处理的异常堆栈

### 附加信息
- **日志**:
  ```
  Error: SpeechRecognitionError: CONFIG_INVALID
      at validateConfig (speech-recognition.service.ts:165)
      at new SpeechRecognitionService (speech-recognition.service.ts:116)
  ```
- **频率**: 必现

### 相关用例
- **测试用例ID**: SP002

### 处理记录
- **确认人**: 李四
- **确认日期**: 2026-01-31
- **分配给谁**: 王五
- **修复版本**: 1.0.0-beta.2
- **验证人**: 张三
- **验证日期**: 2026-02-01
- **验证结果**: 通过
- **备注**: 已添加try-catch处理和用户友好的错误提示
```

---

## 5. 缺陷状态跟踪表

### 5.1 当前缺陷列表

| 缺陷ID | 标题 | 模块 | 级别 | 状态 | 报告人 | 负责人 | 创建日期 | 目标日期 | 实际日期 |
|--------|------|------|------|------|--------|--------|----------|----------|----------|
| BUG-20260127-001 | WebSocket连接失败后无限重连 | 语音识别 | P1 | 待验证 | 测试工程师A | 后端开发B | 2026-01-27 | 2026-01-27 | 2026-01-27 |
| BUG-20260127-002 | 音频数据发送在弱网环境下超时 | 语音识别 | P2 | 待验证 | 测试工程师A | 后端开发B | 2026-01-27 | 2026-01-28 | 2026-01-27 |
| BUG-20260127-003 | 重连机制在特定条件下失效 | 语音识别 | P1 | 待验证 | 测试工程师A | 后端开发B | 2026-01-27 | 2026-01-27 | 2026-01-27 |
| | | | | | | | | | |
| | | | | | | | | | |

### 5.2 缺陷统计

#### 按模块统计

| 模块 | 新建 | 确认 | 修复中 | 待验证 | 已关闭 | 拒绝 | 延期 | 总计 |
|------|------|------|--------|--------|--------|------|------|------|
| 语音识别服务 | 0 | 0 | 0 | 3 | 0 | 0 | 0 | 3 |
| 截图服务 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 图像识别服务 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| AI内容生成服务 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 自动更新服务 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| **总计** | **3** | **0** | **0** | **0** | **0** | **0** | **0** | **3** |

#### 按严重级别统计

| 级别 | 新建 | 确认 | 修复中 | 待验证 | 已关闭 | 总计 |
|------|------|------|--------|--------|--------|------|
| P0 - 致命 | 0 | 0 | 0 | 0 | 0 | 0 |
| P1 - 严重 | 2 | 0 | 0 | 0 | 0 | 2 |
| P2 - 一般 | 1 | 0 | 0 | 0 | 0 | 1 |
| P3 - 轻微 | 0 | 0 | 0 | 0 | 0 | 0 |
| **总计** | **0** | **0** | **0** | **3** | **0** | **3** |

#### 缺陷趋势

| 日期 | 新增 | 修复 | 关闭 | 遗留 |
|------|------|------|------|------|
| Week 1 | 0 | 0 | 0 | 0 |
| Week 2 | 0 | 0 | 0 | 0 |
| Week 3 | 0 | 0 | 0 | 0 |
| Week 4 | 0 | 0 | 0 | 0 |

---

## 6. 缺陷分析

### 6.1 缺陷根因分类

| 根因类别 | 描述 | 数量 | 占比 |
|----------|------|------|------|
| 需求问题 | 需求不明确或变更 | 0 | 0% |
| 设计问题 | 设计缺陷或考虑不周 | 0 | 0% |
| 编码问题 | 代码逻辑错误 | 0 | 0% |
| 配置问题 | 配置错误或遗漏 | 0 | 0% |
| 环境问题 | 测试环境问题 | 0 | 0% |
| 数据问题 | 测试数据问题 | 0 | 0% |
| 其他 | 其他原因 | 0 | 0% |

### 6.2 缺陷发现阶段

| 阶段 | 数量 | 占比 |
|------|------|------|
| 单元测试 | 0 | 0% |
| 集成测试 | 0 | 0% |
| 系统测试 | 0 | 0% |
| 验收测试 | 0 | 0% |
| 生产环境 | 0 | 0% |

### 6.3 缺陷修复效率

| 严重级别 | 平均修复时间(小时) | 目标时间(小时) |
|----------|-------------------|----------------|
| P0 | - | 24 |
| P1 | - | 48 |
| P2 | - | 168 (1周) |
| P3 | - | 336 (2周) |

---

## 7. 缺陷预防建议

### 7.1 常见缺陷模式

| 模式 | 描述 | 预防措施 |
|------|------|----------|
| 空值未检查 | 未对null/undefined进行检查 | 启用严格类型检查，添加非空断言 |
| 边界条件 | 未处理边界值 | 增加边界值测试用例 |
| 异步错误 | Promise错误未捕获 | 统一错误处理中间件 |
| 配置缺失 | 必要配置项未提供 | 配置验证Schema |
| API变更 | 第三方API变更 | API版本锁定，定期监控 |

### 7.2 改进措施

1. **代码审查加强**
   - 重点关注错误处理逻辑
   - 检查边界条件处理
   - 验证配置验证完整性

2. **测试覆盖提升**
   - 增加异常路径测试
   - 补充边界条件测试
   - 加强Mock测试

3. **文档完善**
   - 更新API集成文档
   - 完善配置说明
   - 补充故障排查指南

---

## 8. 缺陷详情

### BUG-20260127-001: WebSocket连接失败后无限重连

**基本信息**:
| 项目 | 内容 |
|------|------|
| **缺陷ID** | BUG-20260127-001 |
| **标题** | WebSocket连接失败后无限重连 |
| **模块** | 语音识别服务 |
| **级别** | P1 - 严重 |
| **状态** | 新建 |
| **报告人** | 测试工程师A |
| **负责人** | 待分配 |
| **创建日期** | 2026-01-27 |
| **目标日期** | 2026-01-27 |

**问题描述**:
当WebSocket连接失败时（如网络断开、服务器不可用），语音识别服务会无限次尝试重连，导致CPU占用率飙升，且无法通过正常方式停止重连。

**复现步骤**:
1. 启动语音识别服务
2. 配置有效的API密钥
3. 点击"连接服务"按钮
4. 在连接过程中断开网络
5. 观察控制台日志，发现重连循环持续进行

**预期结果**:
连接失败后应该：
1. 最多重试3次
2. 每次重试间隔递增（1s, 2s, 4s）
3. 达到最大重试次数后停止，并报告错误
4. 用户可以手动触发重新连接

**实际结果**:
1. 重连无限循环进行
2. 没有重试次数限制
3. CPU占用率持续升高
4. 必须重启应用才能停止

**环境信息**:
- OS: Windows 10 22H2
- Python: 3.11.7
- 分支: main
- 提交: 763063f

**错误日志**:
```
[SpeechRecognition] WebSocket connection failed, retrying...
[SpeechRecognition] WebSocket connection failed, retrying...
[SpeechRecognition] WebSocket connection failed, retrying...
... (无限循环)
```

**可能原因**:
- `speech-recognition.service.ts` 中的重连逻辑缺少最大重试次数限制
- 没有实现指数退避策略
- 错误处理中没有区分可恢复错误和不可恢复错误

**修复建议**:
1. 添加 `maxRetryAttempts` 配置项（默认3次）
2. 实现指数退避重试策略
3. 达到最大重试次数后触发 `onError` 回调并停止重试
4. 添加 `stopRetrying()` 方法供外部调用

**修复信息**:
- **修复人员**: 后端开发B
- **修复日期**: 2026-01-27
- **修复提交**: `fix/bug-001-websocket-reconnect`
- **修复说明**:
  1. 在 `handleDisconnect` 方法中添加 `isReconnecting` 标志，防止同时触发多个重连
  2. 实现指数退避策略：`delay = 1000ms * 2^(attempt-1)`，即 1s, 2s, 4s
  3. 达到最大重试次数后触发 `error` 事件并停止重连
  4. 添加 `stopReconnecting()` 公共方法供外部调用停止重连
  5. 在 `disconnect()` 方法中清理重连定时器并重置状态

**代码变更**:
```typescript
// 新增状态变量
private isReconnecting = false
private reconnectDelayBase = 1000

// 修复后的重连逻辑
const delay = this.reconnectDelayBase * Math.pow(2, this.reconnectAttempts - 1)
if (this.reconnectAttempts >= this.maxReconnectAttempts) {
  this.emit('error', new SpeechRecognitionError(...))
}
```

**验证结果**: ⏳ 待测试工程师验证

---

### BUG-20260127-002: 音频数据发送在弱网环境下超时

**基本信息**:
| 项目 | 内容 |
|------|------|
| **缺陷ID** | BUG-20260127-002 |
| **标题** | 音频数据发送在弱网环境下超时 |
| **模块** | 语音识别服务 |
| **级别** | P2 - 一般 |
| **状态** | 新建 |
| **报告人** | 测试工程师A |
| **负责人** | 待分配 |
| **创建日期** | 2026-01-27 |
| **目标日期** | 2026-01-28 |

**问题描述**:
在网络延迟较高或带宽受限的环境下，发送音频数据时经常超时，但没有明确的超时提示，用户无法感知到问题。

**复现步骤**:
1. 使用网络模拟工具设置延迟 500ms，带宽 100kbps
2. 启动语音识别并连接服务
3. 开始录音
4. 观察音频数据发送情况

**预期结果**:
1. 音频数据发送有合理的超时时间（如5秒）
2. 超时后应该提示用户网络状况不佳
3. 自动尝试重发或优雅降级

**实际结果**:
1. 音频数据发送超时没有提示
2. 用户不知道录音是否正常工作
3. 识别结果返回延迟或丢失

**环境信息**:
- OS: Windows 10 22H2
- Python: 3.11.7
- 网络: 模拟弱网环境（延迟500ms，带宽100kbps）

**修复建议**:
1. 为 `sendAudio` 添加超时机制（默认5秒）
2. 超时后提示用户"网络状况不佳，请检查网络连接"
3. 实现音频数据缓冲队列，网络恢复后自动重发
4. 添加网络状态监控，网络差时自动暂停录音

**修复信息**:
- **修复人员**: 后端开发B
- **修复日期**: 2026-01-27
- **修复提交**: `fix/bug-002-audio-send-timeout`
- **修复说明**:
  1. 将 `sendAudioData` 方法改为异步方法，返回 `Promise<void>`
  2. 添加 5 秒超时机制，超时后触发 `networkWarning` 事件
  3. 实现连续超时检测，超过 3 次连续超时触发 `networkError` 事件
  4. 成功发送后重置连续超时计数器
  5. 添加详细的网络状态日志

**代码变更**:
```typescript
// 新增超时配置
private readonly AUDIO_SEND_TIMEOUT = 5000
private consecutiveTimeouts = 0
private readonly MAX_CONSECUTIVE_TIMEOUTS = 3

// 异步发送并添加超时
return new Promise((resolve, reject) => {
  const timeoutId = setTimeout(() => {
    this.consecutiveTimeouts++
    this.emit('networkWarning', {...})
  }, this.AUDIO_SEND_TIMEOUT)

  this.ws!.send(JSON.stringify(frame), (error) => {
    clearTimeout(timeoutId)
    // 重置超时计数器
    if (this.consecutiveTimeouts > 0) {
      this.consecutiveTimeouts = 0
    }
  })
})
```

**验证结果**: ⏳ 待测试工程师验证

---

### BUG-20260127-003: 重连机制在特定条件下失效

**基本信息**:
| 项目 | 内容 |
|------|------|
| **缺陷ID** | BUG-20260127-003 |
| **标题** | 重连机制在特定条件下失效 |
| **模块** | 语音识别服务 |
| **级别** | P1 - 严重 |
| **状态** | 新建 |
| **报告人** | 测试工程师A |
| **负责人** | 待分配 |
| **创建日期** | 2026-01-27 |
| **目标日期** | 2026-01-27 |

**问题描述**:
当连接在短时间内（< 5秒）多次断开时，重连机制会失效，后续所有连接尝试都会直接失败，必须重启应用才能恢复。

**复现步骤**:
1. 启动语音识别服务
2. 连接到服务器
3. 开始录音
4. 手动断开网络5秒
5. 恢复网络，等待自动重连
6. 再次断开网络5秒
7. 恢复网络，观察重连情况

**预期结果**:
每次网络恢复后都应该能自动重连成功

**实际结果**:
第二次及以后的网络恢复后，重连失败，提示"重连机制已失效"

**环境信息**:
- OS: Windows 10 22H2
- Python: 3.11.7
- 分支: main

**可能原因**:
- 重连计数器没有正确重置
- WebSocket实例没有正确清理
- 状态机管理有问题

**修复建议**:
1. 检查 `reconnectAttempts` 计数器重置逻辑
2. 确保每次重连前清理旧的WebSocket实例
3. 添加更完善的状态管理（idle/connecting/connected/reconnecting/error）
4. 添加单元测试覆盖快速重连场景

**修复信息**:
- **修复人员**: 后端开发B
- **修复日期**: 2026-01-27
- **修复提交**: `fix/bug-003-reconnect-state`
- **修复说明**:
  1. 在 `connect()` 方法开头清理任何现有的重连定时器
  2. 手动连接时重置 `reconnectAttempts` 计数器
  3. 重连成功时重置 `isReconnecting` 标志和 `consecutiveTimeouts`
  4. 连接成功时触发 `stateReset` 事件
  5. 添加 `resetConnectionState()` 公共方法供外部手动重置状态
  6. 在 `disconnect()` 方法中彻底重置所有状态

**代码变更**:
```typescript
// 在 connect() 方法中
if (!this.isReconnecting) {
  this.reconnectAttempts = 0
}

// 在连接成功时
this.reconnectAttempts = 0
this.isReconnecting = false
this.consecutiveTimeouts = 0

// 新增公共方法
resetConnectionState(): void {
  this.reconnectAttempts = 0
  this.isReconnecting = false
  this.consecutiveTimeouts = 0
}
```

**验证结果**: ⏳ 待测试工程师验证

---

## 9. 附录

### 8.1 缺陷ID编码规则

```
BUG-[YYYYMMDD]-[NNN]

例如:
BUG-20260131-001  - 2026年1月31日的第1个缺陷
BUG-20260131-002  - 2026年1月31日的第2个缺陷
```

### 8.2 缺陷状态转换规则

| 当前状态 | 允许转换到 | 条件 |
|----------|-----------|------|
| 新建 | 确认 | 测试负责人确认是缺陷 |
| 新建 | 重复 | 与已有缺陷重复 |
| 新建 | 拒绝 | 不是缺陷或无法复现 |
| 确认 | 修复中 | 分配给开发人员 |
| 确认 | 延期 | 产品经理决定延期 |
| 修复中 | 待验证 | 开发完成修复 |
| 待验证 | 关闭 | 测试验证通过 |
| 待验证 | 重开 | 测试验证未通过 |
| 重开 | 修复中 | 重新分配给开发人员 |
| 延期 | 确认 | 决定在当前版本修复 |
| 拒绝 | 新建 | 有新的证据表明是缺陷 |

### 8.3 变更历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2026-01-31 | 初始版本 | 测试团队 |
