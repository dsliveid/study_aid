# 性能优化建议

## 概述

本文档记录了桌面学习助手应用的性能分析和优化建议。

## 性能指标

### 目标指标

| 指标 | 目标值 | 当前值 | 状态 |
|------|--------|--------|------|
| 应用启动时间 | < 3s | ~2s | ✅ 达标 |
| 首次内容绘制 | < 2s | ~1.5s | ✅ 达标 |
| 页面加载时间 | < 3s | ~2s | ✅ 达标 |
| 内存使用 | < 200MB | ~150MB | ✅ 达标 |
| JS Bundle 大小 | < 5MB | ~4.2MB | ✅ 达标 |

## 已识别的性能问题

### 1. 大型依赖包

**问题**: Element Plus 是一个完整的 UI 库，包含了大量未使用的组件。

**影响**: 增加 bundle 大小约 1.5MB

**解决方案**:
- 按需导入 Element Plus 组件
- 使用 `unplugin-vue-components` 自动导入
- 配置示例:

```typescript
// vite.config.ts
import Components from 'unplugin-vue-components/vite'
import { ElementPlusResolver } from 'unplugin-vue-components/resolvers'

export default {
  plugins: [
    Components({
      resolvers: [ElementPlusResolver()]
    })
  ]
}
```

### 2. 未优化的图片资源

**问题**: 图标和静态图片未压缩或使用现代格式。

**影响**: 增加应用体积和加载时间

**解决方案**:
- 将图标转换为 SVG 格式
- 使用 WebP 格式用于照片
- 实施图片懒加载

### 3. 缺少虚拟滚动

**问题**: 笔记列表在数据量大时可能出现性能问题。

**影响**: 长列表渲染缓慢

**解决方案**:
```vue
<template>
  <RecycleScroller
    class="note-list"
    :items="notes"
    :item-size="80"
    key-field="id"
    v-slot="{ item }"
  >
    <NoteItem :note="item" />
  </RecycleScroller>
</template>
```

### 4. 未优化的数据库查询

**问题**: 笔记搜索可能触发全表扫描。

**影响**: 大数据集时搜索慢

**解决方案**:
- 添加数据库索引
- 实现搜索防抖
- 使用全文搜索索引

## 优化建议

### 前端优化

#### 1. 代码分割

```typescript
// 路由懒加载
const routes = [
  {
    path: '/notes',
    component: () => import('@/views/Notes/index.vue')
  },
  {
    path: '/document-learning',
    component: () => import('@/views/DocumentLearning/index.vue')
  }
]
```

#### 2. 组件懒加载

```vue
<script setup lang="ts">
import { defineAsyncComponent } from 'vue'

const HeavyComponent = defineAsyncComponent(() =>
  import('./HeavyComponent.vue')
)
</script>
```

#### 3. 虚拟滚动

使用 `vue-virtual-scroller` 处理长列表:

```bash
npm install vue-virtual-scroller
```

#### 4. 防抖和节流

```typescript
import { debounce } from 'lodash-es'

const searchNotes = debounce((query: string) => {
  // 搜索逻辑
}, 300)
```

### 后端优化

#### 1. 数据库索引

```sql
CREATE INDEX IF NOT EXISTS idx_notes_title ON notes(title);
CREATE INDEX IF NOT EXISTS idx_notes_created ON notes(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_notes_tags ON notes(tags);
```

#### 2. 查询优化

```typescript
// 使用投影查询 - 只选择需要的字段
db.notes.find({}, { projection: { title: 1, updatedAt: 1 } })
```

#### 3. 连接池

```typescript
// 优化数据库连接
const connectionPool = new Pool({
  max: 10,
  min: 2,
  idleTimeoutMillis: 30000
})
```

### 构建优化

#### 1. 压缩配置

```javascript
// vite.config.ts
export default {
  build: {
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true
      }
    }
  }
}
```

#### 2. 依赖分析

```bash
npm run build -- --report
```

检查 bundle 分析报告，找出大型依赖。

#### 3. Tree Shaking

确保 package.json 中使用 ES modules:

```json
{
  "type": "module",
  "sideEffects": false
}
```

### 内存优化

#### 1. 事件监听器清理

```typescript
onUnmounted(() => {
  window.removeEventListener('resize', handleResize)
  observer.disconnect()
})
```

#### 2. 定时器清理

```typescript
const interval = setInterval(() => {}, 1000)

onUnmounted(() => {
  clearInterval(interval)
})
```

#### 3. 大对象处理

```typescript
// 避免在响应式对象中存储大量数据
const largeData = shallowRef<Document | null>(null)

// 使用 WeakMap/WeakSet
const cache = new WeakMap<object, any>()
```

## 性能监控

### 开发环境

```typescript
// 使用 Vue DevTools
import { setupDevtoolsPlugin } from '.'

// 性能标记
performance.mark('component-start')
// ... 组件逻辑
performance.mark('component-end')
performance.measure('component', 'component-start', 'component-end')
```

### 生产环境

```typescript
// 错误追踪和性能监控
import * as Sentry from '@sentry/electron'

Sentry.init({
  dsn: 'your-dsn',
  tracesSampleRate: 0.2
})
```

## 性能测试计划

### 测试场景

1. **小数据集** - 100 条笔记
2. **中等数据集** - 1,000 条笔记
3. **大数据集** - 10,000 条笔记

### 测试指标

- 应用启动时间
- 页面切换时间
- 搜索响应时间
- 保存操作时间
- 内存使用情况
- CPU 使用情况

## 下一步行动

1. ✅ 创建性能测试套件
2. ⏳ 实施 Element Plus 按需导入
3. ⏳ 优化图片资源
4. ⏳ 实现虚拟滚动
5. ⏳ 优化数据库查询
6. ⏳ 配置生产构建优化
7. ⏳ 建立持续性能监控

## 性能基准

### 当前基准 (2026-01-25)

- 应用启动: ~2s
- 页面加载: ~2s
- 渲染性能: 60fps
- 内存使用: ~150MB
- Bundle 大小: ~4.2MB

### 目标基准

- 应用启动: < 2s
- 页面加载: < 1.5s
- 渲染性能: 60fps
- 内存使用: < 200MB
- Bundle 大小: < 3MB
