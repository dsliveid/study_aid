# 区域截图功能测试指南

## 已完成的修复

### 1. 创建了区域选择器 HTML 文件
- 文件位置: `src/renderer/screenshot-selector.html`
- 功能: 全屏透明窗口，支持鼠标拖动选择区域

### 2. 添加了构建脚本
- 自动将 HTML 文件复制到 `out/renderer` 目录

### 3. 更新了 preload API
- 添加了 `openRegionSelector` 方法

### 4. 修复了前端调用
- `captureRegion` 函数现在正确调用区域选择器

### 5. 添加了详细的调试日志
- 主进程和渲染进程都有完整的日志输出

---

## 测试步骤

### 1. 重启应用
**重要**: 必须重启应用才能应用主进程的更改

```bash
# 停止当前运行的应用（Ctrl+C）
# 然后重新启动
npm run dev
```

### 2. 打开开发者工具
- 在应用中按 `Ctrl+Shift+I` 或 `F12` 打开开发者工具
- 切换到 Console 标签查看日志

### 3. 测试区域截图
1. 点击"区域截图"按钮
2. 屏幕应该变暗，显示提示："拖动鼠标选择截图区域，按 ESC 键取消"
3. 按住鼠标左键拖动选择区域
4. 松开鼠标后应该显示工具栏（确认/取消按钮）
5. 点击"确认截图"

### 4. 查看日志
如果截图没有成功，请在控制台中查看日志：

**前端日志** (浏览器 Console):
```
[VideoLearning] 开始区域截图...
[VideoLearning] 调用 openRegionSelector API...
```

**主进程日志** (终端):
```
[ScreenshotService] 打开区域选择窗口...
[ScreenshotService] 加载截图选择器: { isDev: true, htmlPath: '...' }
[ScreenshotService] HTML 加载完成
[ScreenshotSelector Window] info: 拖动鼠标选择截图区域...
```

---

## 常见问题排查

### 问题 1: 点击区域截图没有反应
**检查**: 浏览器控制台是否有错误
```
[VideoLearning] openRegionSelector 返回结果: { hasResult: false }
```

**解决**: 确保已重启应用

### 问题 2: 区域选择窗口无法加载
**检查**: 主进程日志
```
[ScreenshotService] HTML 加载失败: { errorCode: 'ERR_FILE_NOT_FOUND' }
```

**解决**: 运行 `npm run copy:screenshot` 手动复制文件

### 问题 3: 点击确认按钮没有效果
**检查**: 区域选择器窗口的控制台
```
[ScreenshotSelector] 用户按 ESC 取消
```

**解决**:
- 确保点击的是"确认截图"按钮，不是"取消"
- 查看是否有 JavaScript 错误

### 问题 4: 截图完成后没有显示
**检查**: 主进程日志
```
[ScreenshotService] 收到 IPC 消息: screenshot-selected
[ScreenshotService] 截图已保存: screenshot_...
```

**解决**:
- 检查返回的 dataUrl 是否为空
- 确认前端是否正确处理返回结果

---

## 调试命令

### 手动复制 HTML 文件
```bash
node scripts/copy-screenshot-html.js
```

### 检查文件是否存在
```bash
ls -la out/renderer/screenshot-selector.html
```

### 查看完整构建输出
```bash
npm run build
```

---

## 预期行为

1. ✅ 点击"区域截图"后，屏幕变暗显示选择界面
2. ✅ 拖动鼠标显示红色虚线选择框
3. ✅ 松开鼠标显示工具栏
4. ✅ 点击"确认截图"后，截图显示在预览区域
5. ✅ 控制台显示完整的操作日志

---

## 如果仍然无法工作

请提供以下信息以便进一步排查：

1. **浏览器控制台日志** (完整的错误信息)
2. **主进程终端日志** (从启动到点击确认按钮的所有输出)
3. **截图选择器窗口的控制台日志** (如果窗口能打开)

---

**创建时间**: 2026-01-26
**修复内容**: 区域截图功能完整实现
